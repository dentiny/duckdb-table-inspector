# name: test/sql/inspect_database/inspect_database.test
# description: test inspect_database function with persistent databases and precise size calculation
# group: [table_inspector]

require table_inspector

# Create and use a persistent database file
statement ok
ATTACH '__TEST_DIR__/test_inspect.duckdb' AS testdb;

statement ok
USE testdb;

# Empty database should return 0 rows
query I
SELECT COUNT(*) FROM inspect_database();
----
0

# Create some tables
statement ok
CREATE TABLE tbl1 (id int);

statement ok
CREATE TABLE tbl2 (txt varchar);

# It should find all user-created tables in the main schema
query T
SELECT table_name FROM inspect_database() ORDER BY table_name;
----
tbl1
tbl2

# It should not list tables from internal schemas
query I
SELECT COUNT(*) FROM inspect_database() WHERE schema_name = 'information_schema';
----
0

# It should find tables in custom schemas
statement ok
CREATE SCHEMA s1;

statement ok
CREATE TABLE s1.tbl3 (id int);

query TT
SELECT schema_name, table_name FROM inspect_database() WHERE schema_name = 's1';
----
s1	tbl3

# Test column_count is correct (tbl1 has 1 column: id int)
query I
SELECT column_count FROM inspect_database() WHERE table_name = 'tbl1';
----
1

# Test row_count for empty table
query I
SELECT row_count FROM inspect_database() WHERE table_name = 'tbl1';
----
0

# Insert data and verify row_count updates
statement ok
INSERT INTO tbl1 VALUES (1), (2), (3);

# CHECKPOINT to persist data to disk
statement ok
CHECKPOINT;

query I
SELECT row_count FROM inspect_database() WHERE table_name = 'tbl1';
----
3

# Test size_bytes is non-zero after CHECKPOINT
query I
SELECT size_bytes > 0 FROM inspect_database() WHERE table_name = 'tbl1';
----
true

# Test size_format is not "0 B"
query I
SELECT size_format != '0 B' FROM inspect_database() WHERE table_name = 'tbl1';
----
true

# Create a table with multiple columns to test column_count
statement ok
CREATE TABLE multi_col (a INT, b VARCHAR, c DOUBLE, d BOOLEAN);

query I
SELECT column_count FROM inspect_database() WHERE table_name = 'multi_col';
----
4

# Insert data into multi_col and checkpoint
statement ok
INSERT INTO multi_col VALUES (1, 'test', 1.5, true), (2, 'data', 2.5, false);

statement ok
CHECKPOINT;

# Verify multi_col has size
query I
SELECT size_bytes > 0 FROM inspect_database() WHERE table_name = 'multi_col';
----
true

# Verify that we can query all columns successfully
query I
SELECT COUNT(*) FROM (
    SELECT database_name, schema_name, table_name, row_count, column_count, size_bytes, size_format
    FROM inspect_database()
);
----
4

# Verify database_name is correct
query T
SELECT DISTINCT database_name FROM inspect_database();
----
testdb

# Verify tables are sorted by size descending
query I
SELECT COUNT(*) FROM (
    SELECT size_bytes, 
           LAG(size_bytes) OVER () as prev_size
    FROM inspect_database()
) WHERE prev_size IS NULL OR prev_size >= size_bytes;
----
4

# Cleanup
statement ok
USE memory;

statement ok
DETACH testdb;
