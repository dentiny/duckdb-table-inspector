# name: test/sql/inspect_database.test
# description: test inspect_database function
# group: [table_inspector]

require table_inspector

# =====================================================
# Test 1: Default in-memory database should throw error
# =====================================================

statement error
SELECT * FROM inspect_database();
----
inspect_database() requires a persistent database file

# =====================================================
# Test 2: Explicit :memory: database via ATTACH
# =====================================================

statement ok
ATTACH ':memory:' AS memdb;

statement ok
USE memdb;

statement ok
CREATE TABLE test_table (id INT);

# Should still fail because memdb is in-memory
statement error
SELECT * FROM inspect_database();
----
inspect_database() requires a persistent database file

# Cleanup
statement ok
USE memory;

statement ok
DETACH memdb;

# =====================================================
# Test 3: Persistent database should work
# =====================================================

# Create and use a persistent database file
statement ok
ATTACH '__TEST_DIR__/test_inspect.duckdb' AS testdb;

statement ok
USE testdb;

# Empty database should return 0 rows
query I
SELECT COUNT(*) FROM inspect_database();
----
0

# Create some tables
statement ok
CREATE TABLE tbl1 (id int);

statement ok
CREATE TABLE tbl2 (txt varchar);

# It should find all user-created tables in the main schema
query T
SELECT table_name FROM inspect_database() ORDER BY table_name;
----
tbl1
tbl2

# It should not list tables from internal schemas
query I
SELECT COUNT(*) FROM inspect_database() WHERE schema_name = 'information_schema';
----
0

# It should find tables in custom schemas
statement ok
CREATE SCHEMA s1;

statement ok
CREATE TABLE s1.tbl3 (id int);

query TT
SELECT schema_name, table_name FROM inspect_database() WHERE schema_name = 's1';
----
s1	tbl3

# Check placeholder values for currently unimplemented columns
query III
SELECT row_count, column_count, size_bytes FROM inspect_database() WHERE table_name = 'tbl1';
----
0	0	0

# Cleanup
statement ok
USE memory;

statement ok
DETACH testdb;
